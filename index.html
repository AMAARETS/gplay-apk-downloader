<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××•×¨×™×“ APK ××ª×§×“×</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #bb86fc; --text: #e0e0e0; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h1, h2 { color: var(--primary); margin-top: 0; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        select, input, button { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; box-sizing: border-box;}
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #333; color: white; }
        
        .app-result { display: flex; align-items: center; gap: 15px; padding: 10px; background: #252525; margin-bottom: 8px; border-radius: 8px; }
        .app-result button { width: auto; padding: 8px 16px; margin-right: auto; }
        
        .status-box { padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }
        .status-box.info { background: #0d47a1; display: block; }
        .status-box.success { background: #1b5e20; display: block; }
        .status-box.error { background: #b71c1c; display: block; }
        
        .progress-bar { width: 100%; height: 6px; background: #444; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“¥ GPlay Downloader</h1>
    
    <!-- ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª -->
    <div class="card">
        <h2>âš™ï¸ ×”×’×“×¨×•×ª</h2>
        <div class="controls">
            <div>
                <label>××–×•×¨ (×—× ×•×ª):</label>
                <select id="region">
                    <option value="il" selected>ğŸ‡®ğŸ‡± ×™×©×¨××œ (Partner)</option>
                    <option value="us">ğŸ‡ºğŸ‡¸ ××¨×”"×‘ (T-Mobile)</option>
                    <option value="de">ğŸ‡©ğŸ‡ª ×’×¨×× ×™×”</option>
                </select>
            </div>
            <div>
                <label>××›×©×™×¨:</label>
                <select id="device">
                    <option value="s23" selected>Samsung S23 (××•××œ×¥)</option>
                    <option value="pixel7">Google Pixel 7a</option>
                    <option value="j7">Samsung J7 (×™×©×Ÿ 32bit)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ×—×™×¤×•×© -->
    <div class="card">
        <h2>ğŸ” ×—×™×¤×•×© ×•×”×•×¨×“×”</h2>
        <div class="controls" style="grid-template-columns: 3fr 1fr;">
            <input type="text" id="pkg" placeholder="×©× ×—×‘×™×œ×” (com.waze) ××• ×—×™×¤×•×©">
            <button onclick="handleSearch()">×—×¤×© / ×‘×“×•×§</button>
        </div>
        <div id="search-results"></div>
    </div>

    <!-- ××–×•×¨ ×”×•×¨×“×” -->
    <div id="status-area" class="status-box"></div>
</div>

<script>
    let currentData = null;
    let eventSource = null;

    function getSettings() {
        return `region=${document.getElementById('region').value}&device=${document.getElementById('device').value}`;
    }

    async function handleSearch() {
        const query = document.getElementById('pkg').value.trim();
        if(!query) return;

        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = '<div style="text-align:center">××—×¤×©...</div>';

        // ×× ×–×” × ×¨××” ×›××• ×©× ×—×‘×™×œ×”
        if (query.includes('.') && !query.includes(' ')) {
            getInfo(query);
            return;
        }

        // ××—×¨×ª ×—×™×¤×•×©
        try {
            const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&${getSettings()}`);
            const data = await res.json();
            
            if(data.results) {
                resultsDiv.innerHTML = data.results.map(app => `
                    <div class="app-result">
                        <div>
                            <div style="font-weight:bold">${app.title}</div>
                            <div style="font-size:0.8em; opacity:0.7">${app.package}</div>
                        </div>
                        <button onclick="getInfo('${app.package}')">×‘×—×¨</button>
                    </div>
                `).join('');
            }
        } catch(e) {
            resultsDiv.innerHTML = '×©×’×™××” ×‘×—×™×¤×•×©';
        }
    }

    async function getInfo(pkg) {
        const el = document.getElementById('status-area');
        el.className = 'status-box info';
        el.innerHTML = '××§×‘×œ ×¤×¨×˜×™×...';
        
        try {
            const res = await fetch(`/api/info/${pkg}?${getSettings()}`);
            const data = await res.json();
            
            el.innerHTML = `
                <h3>${data.title}</h3>
                <div>××¤×ª×—: ${data.developer}</div>
                <div style="margin-top:10px">
                    <button onclick="startDownload('${data.package}')">ğŸš€ ×”×ª×—×œ ×ª×”×œ×™×š ×”×•×¨×“×”</button>
                </div>
            `;
        } catch(e) {
            el.className = 'status-box error';
            el.innerHTML = '×©×’×™××” ×‘×§×‘×œ×ª ×¤×¨×˜×™×: ' + e;
        }
    }

    function startDownload(pkg) {
        if(eventSource) eventSource.close();
        
        const el = document.getElementById('status-area');
        el.className = 'status-box info';
        el.innerHTML = '××ª×—×‘×¨ ×œ×©×¨×ª ×œ×§×‘×œ×ª ×§×™×©×•×¨ ×”×•×¨×“×”...<div class="progress-bar"><div class="fill" style="width:10%"></div></div>';

        eventSource = new EventSource(`/api/download-info-stream/${pkg}?${getSettings()}`);
        
        eventSource.onmessage = function(e) {
            const msg = JSON.parse(e.data);
            
            if(msg.type === 'progress') {
                el.innerHTML = `${msg.msg}<div class="progress-bar"><div class="fill" style="width:50%"></div></div>`;
            } else if(msg.type === 'error') {
                el.className = 'status-box error';
                el.innerHTML = `×©×’×™××”: ${msg.msg}`;
                eventSource.close();
            } else if(msg.type === 'success') {
                eventSource.close();
                currentData = msg;
                showDownloadOptions(msg);
            }
        };
    }

    function showDownloadOptions(data) {
        const el = document.getElementById('status-area');
        el.className = 'status-box success';
        
        const splitCount = data.splits.length;
        const totalSize = formatSize(data.size);
        
        let html = `
            <h3>âœ… × ××¦××” ×”×•×¨×“×”!</h3>
            <div>×’×¨×¡×”: ${data.version} (${data.versionCode})</div>
            <div>×’×•×“×œ: ${totalSize}</div>
            <div>×§×‘×¦×™×: ${1 + splitCount} (Base + Splits)</div>
            <div style="display:flex; gap:10px; margin-top:15px;">
        `;

        // ××•×¤×¦×™×” 1: ZIP
        if (splitCount > 0) {
            html += `<button onclick="downloadZip()">ğŸ“¦ ×”×•×¨×“ ×›-ZIP (×œ×œ× ××™×–×•×’)</button>`;
        } else {
             // ×”×•×¨×“×” ×™×©×™×¨×” ×× ××™×Ÿ ×¤×™×¦×•×œ×™×
            const cookieStr = data.cookies.map(c => `${c.name}=${c.value}`).join('; ');
            const proxyUrl = `/proxy-download?url=${encodeURIComponent(data.downloadUrl)}&cookie=${encodeURIComponent(cookieStr)}&name=${data.package}.apk`;
            html += `<a href="${proxyUrl}" target="_blank"><button>â¬‡ï¸ ×”×•×¨×“ APK ××§×•×¨×™</button></a>`;
        }

        html += `</div>`;
        el.innerHTML = html;
    }

    async function downloadZip() {
        if (!currentData) return;
        
        const el = document.getElementById('status-area');
        el.innerHTML += `<div style="margin-top:10px">××›×™×Ÿ ZIP... <span id="zip-prog">0%</span></div>`;
        
        const zip = new JSZip();
        const cookieStr = currentData.cookies.map(c => `${c.name}=${c.value}`).join('; ');
        
        // Helper to fetch via proxy
        const fetchFile = async (url, name) => {
            const proxyUrl = `/proxy-download?url=${encodeURIComponent(url)}&cookie=${encodeURIComponent(cookieStr)}`;
            const res = await fetch(proxyUrl);
            if(!res.ok) throw new Error('Download failed');
            return res.blob();
        };

        try {
            // 1. Base APK
            document.getElementById('zip-prog').innerText = '××•×¨×™×“ Base...';
            const baseBlob = await fetchFile(currentData.downloadUrl, 'base.apk');
            zip.file(`${currentData.package}-base.apk`, baseBlob);

            // 2. Splits
            for(let i=0; i<currentData.splits.length; i++) {
                const s = currentData.splits[i];
                document.getElementById('zip-prog').innerText = `××•×¨×™×“ ${s.name}...`;
                const blob = await fetchFile(s.url, s.name);
                zip.file(`${currentData.package}-${s.name}.apk`, blob);
            }

            // 3. Generate
            document.getElementById('zip-prog').innerText = '×™×•×¦×¨ ×§×•×‘×¥...';
            const content = await zip.generateAsync({type:"blob"});
            
            // 4. Download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `${currentData.package}-${currentData.versionCode}.zip`;
            link.click();
            
            document.getElementById('zip-prog').innerText = '×”×•×©×œ×!';
        } catch(e) {
            alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”-ZIP: ' + e.message);
        }
    }

    function formatSize(bytes) {
        if(bytes == 0) return '0 B';
        var k = 1024, sizes = ['B', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>

</body>
</html>